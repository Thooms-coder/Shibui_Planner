{% extends "layout.html" %}

{% block content %}
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flashes mb-3">
        {% for msg in messages %}
          <div class="alert alert-info">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="container py-4" style="max-width:600px;">
    <h2 class="text-center mb-4">Edit Task Assignment</h2>

    {% if obj.errors %}
      <div class="alert alert-danger">
        {% for err in obj.errors %}
          <div>{{ err }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form
      action="{{ url_for('manage_user_task',
                         action='edit',
                         pkval=obj.data[0].UserTaskID,
                         user_id=user_id) }}"
      method="POST"
      class="card p-4 shadow-sm bg-light rounded"
    >
      <input type="hidden" name="user_id" value="{{ user_id or '' }}">

      {# ─── User selector (admins only) ───────────────────────── #}
      {% if me.UserType == 'Administrator' %}
        <div class="mb-3">
          <label for="user_id" class="form-label">User</label>
          <select id="user_id" name="UserID" class="form-select" required>
            {% for u in obj.choices.users %}
              <option value="{{ u.UserID }}"
                      {% if u.UserID == obj.data[0].UserID %}selected{% endif %}>
                {{ u.UserName }} ({{ u.UserEmail }})
              </option>
            {% endfor %}
          </select>
        </div>
      {% else %}
        <div class="mb-3">
          <label class="form-label">User</label>
          <p class="form-control-plaintext">{{ me.UserName }} (you)</p>
        </div>
      {% endif %}

      {# ─── Task selector ─────────────────────────────────────── #}
      <div class="mb-3">
        <label for="task_id" class="form-label">Task</label>
        <select id="task_id" name="TaskID" class="form-select" required>
          {% for t in obj.choices.tasks %}
            <option value="{{ t.TaskID }}"
                    {% if t.TaskID == obj.data[0].TaskID %}selected{% endif %}>
              {{ t.TaskName }} – {{ t.TaskCategory }}
            </option>
          {% endfor %}
        </select>
      </div>

      {# ─── Editable task name (optional override) ────────────── #}
      <div class="mb-3">
        <label for="TaskName" class="form-label">Task Name</label>
        <input id="TaskName"
               name="TaskName"
               type="text"
               class="form-control"
               value="{{ obj.data[0].TaskName }}">
      </div>

      {# ─── Status ────────────────────────────────────────────── #}
      <div class="mb-3">
        <label for="TaskStatus" class="form-label">Status</label>
        <select id="TaskStatus" name="TaskStatus" class="form-select" required>
          {% for status, label in [
                ('pending',     'Pending'),
                ('in_progress', 'In&nbsp;Progress'),
                ('completed',   'Completed')
              ] %}
            <option value="{{ status }}"
                    {% if status == obj.data[0].TaskStatus|lower %}selected{% endif %}>
              {{ label | safe }}
            </option>
          {% endfor %}
        </select>
      </div>      
      

      {# ─── Intensity & Duration ──────────────────────────────── #}
      <div class="row">
        <div class="mb-3 col-md-6">
          <label for="Intensity" class="form-label">Intensity&nbsp;(1–10)</label>
          <input id="Intensity"
                 name="Intensity"
                 type="number"
                 min="1" max="10"
                 class="form-control"
                 value="{{ obj.data[0].Intensity | default('') }}">
        </div>
        <div class="mb-3 col-md-6">
          <label for="Duration" class="form-label">Duration&nbsp;(minutes)</label>
          <input id="Duration"
                 name="Duration"
                 type="number"
                 min="1"
                 class="form-control"
                 value="{{ obj.data[0].ActualDuration | default('') }}">
        </div>
      </div>

      {# ─── Scheduled start: separate date & time inputs ────────────── #}
      {% set dt = obj.data[0].TaskStartTime %}
      {% if dt %}
        {# dt may be a datetime OR a string "YYYY-MM-DD HH:MM:SS" #}
        {% if dt.__class__.__name__ == 'datetime' %}
          {% set _date = dt.strftime('%Y-%m-%d') %}
          {% set _time = dt.strftime('%H:%M') %}
        {% else %}
          {% set _parts = dt.split(' ') %}
          {% set _date  = _parts[0] %}
          {% set _time  = _parts[1][:5] if _parts|length > 1 else '' %}
        {% endif %}
      {% else %}
        {% set _date = '' %}
        {% set _time = '' %}
      {% endif %}
      

      <div class="row">
        <div class="mb-3 col-md-6">
          <label for="ScheduledDate" class="form-label">Scheduled&nbsp;Date</label>
          <input id="ScheduledDate"
                 name="ScheduledDate"
                 type="date"
                 class="form-control"
                 value="{{ _date }}">
        </div>
        <div class="mb-3 col-md-6">
          <label for="ScheduledTime" class="form-label">Scheduled&nbsp;Time</label>
          <input id="ScheduledTime"
                 name="ScheduledTime"
                 type="time"
                 class="form-control"
                 value="{{ _time }}">
        </div>
      </div>

      {# ─── Submit ────────────────────────────────────────────── #}
      <div class="d-grid">
        <button type="submit" class="btn btn-primary">
          Update Assignment
        </button>
      </div>
    </form>

    {# ─── Delete button (admins only) ─────────────────────────── #}
    {% if me.UserType == 'Administrator' %}
      <form action="{{ url_for('manage_user_task',
                               action='delete',
                               pkval=obj.data[0].UserTaskID) }}"
            method="POST"
            class="mt-3"
            onsubmit="return confirm('Delete this task assignment?');">
        <button type="submit" class="btn btn-danger w-100">
          Delete Assignment
        </button>
      </form>
    {% endif %}
  </div>
{% endblock %}


